# 📘 PrivateSvc – טיפול בשיעורים פרטיים  
**Maqamat – LessonsReport (V1.1.1)**  
_Last updated: 12 Nov 2025_

---

## 🧩 תיאור כללי
המודול `PrivateSvc.js` אחראי על עיבוד רשומות השיעורים הפרטיים המגיעות מהגיליון  
**"ריכוז שיעורים פרטיים"**, ויצירת רשומות מעודכנות בגיליון היעד **"דיווח שיעורים"**.

החל מגרסה **V1.1.1**, נוספה תמיכה בלוגיקת **חריגים לפרטי**, המאפשרת שליטה גמישה ביצירת רשומות בהתאם למידע המגיע מגיליון נוסף בשם **"גיליון-כללי"**.

---

## ⚙️ עיקרי הפונקציונליות

### 1️⃣ עיבוד שיעורים פרטיים רגילים
עבור כל מורה/תלמיד:
- זיהוי תדירות (`פעם בשבועיים`, `שבועי`, ללא תדירות).
- יצירת רשומות ריקות (ללא תאריך שיעור) בגיליון **"דיווח שיעורים"** לפי כללי התדירות.
- שיוך חודש/שנה, הערות, כמות שיעורים ומצב סטטוס (`דווח-טרם שולם`).
- סימון רקע צהוב לתאים ריקים או נדרשים לעדכון.

---

### 2️⃣ טיפול בחריגים לפרטי (V1.1.1)

#### תנאי הפעלה:
אם בעמודת **"חריג"** יש ערך `"חריג"`,  
המערכת בודקת את גיליון **"גיליון-כללי"** כדי לזהות תאריכים פעילים לאותו מורה.

#### שלבים:
1. **שליפת תאריכים פעילים**  
   מתוך גיליון `"גיליון-כללי"` (עמודות `"שם המורה"` ו־`"תאריך פעיל"`).

2. **אם נמצאו תאריכים פעילים**  
   - נוצרת רשומה בגיליון `"דיווח שיעורים"` לכל תאריך פעיל.
   - שדות כמו `"שם המורה"`, `"שם התלמיד"`, `"כמות"`, `"הערות"`, ו־`"חודש תשלום"` מועתקים מהרשומה המקורית.

3. **אם לא נמצאו תאריכים פעילים**  
   - מופעלת **לוגיקת התדירות הרגילה** כאילו לא היה חריג.
   - נוצרת כמות רשומות לפי ערכי `"תדירות"` ו־`"יום בשבוע"` (לדוגמה, פעם בשבועיים).

---

## 🧠 מבנה הפונקציות

| פונקציה | תיאור |
|----------|--------|
| **`processPrivateRows(ctx)`** | הפונקציה הראשית המעבדת את רשומות השיעורים הפרטיים, מזהה חריגים, ומייצרת רשומות חדשות בגיליון היעד. |
| **`handlePrivateExceptions(...)`** | מטפלת בכל המקרים שבהם רשומות סומנו כ־"חריג". יוצרת רשומות לפי תאריכים פעילים בגיליון "גיליון-כללי", או מפעילה fallback ללוגיקת תדירות. |
| **`mmYYYY(value)`** | מחזירה מחרוזת חודש-שנה בפורמט `MM-YYYY`. |
| **`keyForPrivate(teacher, student, dateKey)`** | מחזירה מזהה ייחודי לשורה בפרטי לפי מורה, תלמיד ותאריך שיעור. |
| **`pushBlankPrivate(...)`** | מוסיפה רשומת שיעור ריקה (ללא תאריך) לפי כללי תדירות. |
| **`countExistingAndPendingBlankPrivateByMonth(...)`** | סופרת כמה רשומות ריקות כבר קיימות כדי למנוע כפילויות. |

---

## 🧾 שינויים לפי גרסאות

| גרסה | תאריך | תיאור שינוי |
|-------|--------|-------------|
| **V1.0.0** | 2025-11-12 | גרסה ראשונית – עיבוד שיעורים פרטיים רגילים |
| **V1.1.1** | 2025-11-12 | נוספה לוגיקת חריגים לפרטי עם גיליון "גיליון-כללי" |

---

## 🧩 תלויות (Dependencies)
מודול זה משתמש בשירותים פנימיים נוספים בפרויקט:

- **`Utils.js`** – פונקציות עזר (format, date coercion, indexing)
- **`RowsSvc.js`** – ניהול רשומות בגיליון היעד (insert/update)
- **`ExceptionsSvc.js`** – סינון חריגים לפי הגדרות מערכת
- **`LogSvc.js`** – כתיבת לוגים והרצת ניתוחים
- **`HighlightSvc.js`** – עיצוב צבעים וסטטוסים בגיליון היעד

---

## 🧱 מיקום הפונקציה במבנה הפרויקט

```
Maqamat/
└── LessonsReport/
    ├── 00_Utils.js
    ├── 01_Bootstrap.js
    ├── 02_Main.js
    ├── 10_SheetsSvc.js
    ├── 11_RowsSvc.js
    ├── 12_ExceptionsSvc.js
    ├── 13_ProtectSvc.js
    ├── 20_GroupSvc.js
    ├── 21_PrivateSvc.js  ← כולל לוגיקת חריגים לפרטי
    ├── 30_PostProc.js
    ├── 40_BulkStatusUpdate.js
    ├── 41_BulkStatusQuickUpdate.js
    ├── 70_HighlightSvc.js
    ├── Sidebar.html
    ├── BulkStatusSidebar.html
    └── README_PrivateSvc_V1.1.1.md
```

---

## 🧩 הערות תחזוקה
- בעת שינוי מבנה הגיליון **"גיליון-כללי"** (שמות עמודות, מיקום וכו’) יש לוודא עדכון השדות:
  - `"שם המורה"`
  - `"תאריך פעיל"`
- הקוד מזהה ערך חריג לפי המחרוזת המדויקת `"חריג"`.  
  במקרה של תרגום או שינוי טקסט בעמודה – יש לעדכן את הבדיקה בהתאם.
- תיעוד נוסף מופיע בלוג (`LogSvc.info`) תחת האירוע  
  `"Private exceptions processed"`.

---

© 2025 **Maqamat College**  
פיתוח: יניב רבה  
